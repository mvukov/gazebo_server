version: 2
jobs:
  build:
    docker:
      - image: osrf/ros:melodic-desktop-bionic
    steps:
      - checkout:
          path: src
      - run:
          name: Install packages
          command: |
            apt-get update
            apt-get install -qq -y gazebo9 libgazebo9-dev python3 python3-dev python3-nose python3-pip wget
            pip3 install catkin_tools numpy pybind11 rospkg
            wget https://cmake.org/files/v3.12/cmake-3.12.4-Linux-x86_64.sh
            mkdir -p /opt/cmake
            sh cmake-3.12.4-Linux-x86_64.sh --prefix=/opt/cmake --skip-license
            ln -sf /opt/cmake/bin/cmake /usr/local/bin/cmake
      - run:
          name: Build workspace
          command: |
            source /opt/ros/melodic/setup.bash
            catkin init
            catkin config --cmake-args -DPYTHON_EXECUTABLE=$(which python3)
            catkin build -j2 --no-status --cmake-args -DCMAKE_BUILD_TYPE:STRING=Debug
      - run:
          name: Run tests
          command: |
            source devel/setup.bash
            catkin run_tests gazebo_server -j1 --no-deps --no-status
            catkin_test_results build
